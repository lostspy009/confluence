{# -------------------------------------------------------------------------
  inventory_table_confluence.j2
  Final version:
  - Shows reachable hosts with detailed info (filtered_hosts)
  - Adds unreachable hosts table (unreachable_hosts)
  - Clear visual distinction for each section
  - Clean layout for Confluence wiki rendering
  ------------------------------------------------------------------------- #}

{% set display_group = group_name | default(target_group) | default('all') %}

<h1 style="margin-bottom:6px; text-align:center;">
  {{ (display_group | replace('_',' ') | title) }} Inventory Report
</h1>
<p style="font-size:12px; color:#555; margin-top:0; text-align:center;">
  Generated at {{ '%Y-%m-%d %H:%M:%S' | strftime }}
</p>

{# ==================== Reachable Hosts Table ==================== #}
<h2 style="margin-top:12px; text-align:left;">✅ Reachable Hosts</h2>
<table style="width:100%; border-collapse:collapse; font-size:13px; text-align:center; table-layout:fixed;">
  <colgroup>
    <col style="width:16%;">
    <col style="width:14%;">
    <col style="width:18%;">
    <col style="width:14%;">
    <col style="width:9%;">
    <col style="width:9%;">
    <col style="width:9%;">
    <col style="width:11%;">
  </colgroup>
  <tbody>
    <tr style="background-color:#f4f5f7;">
      <th style="padding:8px;">Hostname</th>
      <th style="padding:8px;">IP Address</th>
      <th style="padding:8px;">OS Version</th>
      <th style="padding:8px;">Kernel</th>
      <th style="padding:8px;">Root Disk</th>
      <th style="padding:8px;">/var</th>
      <th style="padding:8px;">/boot</th>
      <th style="padding:8px;">Status</th>
    </tr>

{% if filtered_hosts | length == 0 %}
  <tr><td colspan="8" style="padding:10px; text-align:center;">
    <b>No reachable hosts found in group '{{ display_group }}'</b>
  </td></tr>
{% else %}
{% for facts in filtered_hosts %}
  {% set mounts = facts.get('ansible_mounts', []) | default([]) %}
  {% set root_mount = (mounts | selectattr('mount', 'equalto', '/') | list | first | default({})) %}
  {% set var_mount  = (mounts | selectattr('mount', 'equalto', '/var') | list | first | default({})) %}
  {% set boot_mount = (mounts | selectattr('mount', 'equalto', '/boot') | list | first | default({})) %}

  {% set root_total_gb = (root_mount.size_total / 1024 / 1024 / 1024) if root_mount and root_mount.get('size_total') else 0 %}
  {% set var_free_gb   = (var_mount.size_available / 1024 / 1024 / 1024) if var_mount and var_mount.get('size_available') else 0 %}
  {% set boot_free_mb  = (boot_mount.size_available / 1024 / 1024) if boot_mount and boot_mount.get('size_available') else 0 %}

  {% set var_class = 'highlight-green' if var_free_gb >= 1 else 'highlight-red' %}
  {% set boot_class = 'highlight-green' if boot_free_mb >= 100 else 'highlight-red' %}

  <tr style="border-bottom:1px solid #e2e8f0; height:44px;">
    <td style="vertical-align:top; padding:6px;">{{ facts.get('ansible_hostname', 'N/A') }}</td>
    <td style="vertical-align:top; padding:6px;">{{ facts.get('ansible_default_ipv4', {}).get('address', 'N/A') }}</td>
    <td style="vertical-align:top; padding:6px;">{{ facts.get('ansible_distribution', 'Unknown') }} {{ facts.get('ansible_distribution_version', '') }}</td>
    <td style="vertical-align:top; padding:6px;">{{ facts.get('ansible_kernel', 'N/A') }}</td>

    <td style="vertical-align:top; padding:6px;">
      {% if root_total_gb %}
        {{ root_total_gb | round(1) }} GB
      {% else %}
        N/A
      {% endif %}
    </td>

    <td style="vertical-align:top; padding:6px;" class="{{ var_class }}" data-highlight-colour="{{ 'green' if var_free_gb >= 1 else 'red' }}">
      {{ var_free_gb | round(2) }} GB
    </td>

    <td style="vertical-align:top; padding:6px;" class="{{ boot_class }}" data-highlight-colour="{{ 'green' if boot_free_mb >= 100 else 'red' }}">
      {{ boot_free_mb | round(1) }} MB
    </td>

    <td style="font-weight:600; text-align:center; vertical-align:middle; white-space:nowrap; min-width:120px; padding:6px;">
      <span style="color:green;">✅ Live</span>
    </td>
  </tr>
{% endfor %}
{% endif %}
  </tbody>
</table>

{# ==================== Unreachable Hosts Table ==================== #}
{% if unreachable_hosts is defined and unreachable_hosts | length > 0 %}
  <h2 style="margin-top:24px; text-align:left;">❌ Unreachable Hosts ({{ unreachable_hosts | length }})</h2>
  <table style="width:100%; border-collapse:collapse; font-size:13px; text-align:center; table-layout:fixed;">
    <colgroup>
      <col style="width:50%;">
      <col style="width:50%;">
    </colgroup>
    <tbody>
      <tr style="background-color:#ffecec;">
        <th style="padding:8px;">Hostname</th>
        <th style="padding:8px;">Status</th>
      </tr>
      {% for host in unreachable_hosts %}
      <tr style="border-bottom:1px solid #e2e8f0;">
        <td style="padding:6px;">{{ host }}</td>
        <td style="padding:6px; color:red; font-weight:600;">Unreachable</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}