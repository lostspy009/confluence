<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ansible AAP Inventory Report</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f9fafc;
      color: #111827;
      margin: 0;
      padding: 2rem;
    }

    h1 {
      text-align: center;
      color: #0b3d91;
      margin-bottom: 1.5rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.05);
    }

    th {
      background-color: #f1f5f9;
      color: #1e293b;
      text-align: left;
      padding: 0.9rem;
      font-weight: 600;
      border-bottom: 2px solid #e2e8f0;
    }

    td {
      padding: 0.9rem;
      border-bottom: 1px solid #e5e7eb;
      font-size: 0.95rem;
    }

    tr:hover {
      background-color: #f9fafb;
    }

    .status-live {
      color: #166534;
      background: rgba(34, 197, 94, 0.16);
      padding: 0.4rem 0.8rem;
      border-radius: 999px;
      font-weight: 600;
    }

    .status-down {
      color: #b91c1c;
      background: rgba(239, 68, 68, 0.16);
      padding: 0.4rem 0.8rem;
      border-radius: 999px;
      font-weight: 600;
    }

    .low-space {
      background: rgba(239, 68, 68, 0.15);
      color: #b91c1c;
      font-weight: 600;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
    }

    .good-space {
      background: rgba(34, 197, 94, 0.15);
      color: #166534;
      font-weight: 600;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1> Ansible AAP Inventory Report </h1>
  <table>
    <thead>
      <tr>
        <th>Hostname</th>
        <th>IP Address</th>
        <th>OS Version</th>
        <th>Kernel</th>
        <th>Root Disk</th>
        <th>/var</th>
        <th>/boot</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% for host in groups['all'] | sort %}
        {% set facts = hostvars[host] %}
        {% set mounts = facts.get('ansible_mounts', []) %}
        {% set root_mount = (mounts | selectattr('mount','==','/') | list | first) %}
        {% set var_mount = (mounts | selectattr('mount','==','/var') | list | first) %}
        {% set boot_mount = (mounts | selectattr('mount','==','/boot') | list | first) %}

        {% set var_free = (var_mount.size_available / 1024 / 1024 / 1024) | float if var_mount and var_mount.size_available is defined else 0 %}
        {% set boot_free = (boot_mount.size_available / 1024 / 1024) | float if boot_mount and boot_mount.size_available is defined else 0 %}

        <tr>
          <td>{{ facts.get('ansible_hostname', host) }}</td>
          <td>{{ facts.get('ansible_default_ipv4', {}).get('address', 'N/A') }}</td>
          <td>{{ facts.get('ansible_distribution', 'Unknown') }} {{ facts.get('ansible_distribution_version', '') }}</td>
          <td>{{ facts.get('ansible_kernel', 'N/A') }}</td>
          <td>
            {% if root_mount %}
              {{ (root_mount.size_total / 1024 / 1024 / 1024) | round(1) }} GB
            {% else %}
              N/A
            {% endif %}
          </td>
          <td>
            {% if var_mount %}
              <span class="{% if var_free < 1 %}low-space{% else %}good-space{% endif %}">
                {{ var_free | round(2) }} GB
              </span>
            {% else %}
              N/A
            {% endif %}
          </td>
          <td>
            {% if boot_mount %}
              <span class="{% if boot_free < 80 %}low-space{% else %}good-space{% endif %}">
                {{ boot_free | round(1) }} MB
              </span>
            {% else %}
              N/A
            {% endif %}
          </td>
          <td>
            {% if host in groups.get('healthcheck_failed_nodes', []) %}
              <span class="status-down">Down</span>
            {% else %}
              <span class="status-live">âœ” Live</span>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</body>
</html>