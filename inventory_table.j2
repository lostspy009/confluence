<h1>AAP Server Inventory Report</h1>
<p>Generated at {{ '%Y-%m-%d %H:%M:%S' | strftime }}</p>

<table>
  <tbody>
    <tr>
      <th>Hostname</th>
      <th>IP Address</th>
      <th>OS Version</th>
      <th>Kernel</th>
      <th>Root Disk Size</th>
      <th>/var Free Space</th>
      <th>/boot Free Space</th>
      <th>DB Services</th>
      <th>Role</th>
      <th>Status</th>
    </tr>

{% set host_list = group_hosts | default(groups[group_name] | default([])) %}
{% for host in host_list %}
  {% set facts = hostvars.get(host, {}) %}
  {% set reachable = facts.get('ansible_facts', facts) | length > 0 %}
  {% set mounts = facts.get('ansible_mounts', []) %}
  {% set root_mount = (mounts | selectattr('mount', 'equalto', '/') | list | first) %}
  {% set var_mount = (mounts | selectattr('mount', 'equalto', '/var') | list | first) %}
  {% set boot_mount = (mounts | selectattr('mount', 'equalto', '/boot') | list | first) %}
  {% set var_free_gb = (var_mount.size_available / 1024 / 1024 / 1024) if var_mount else 0 %}
  {% set boot_free_mb = (boot_mount.size_available / 1024 / 1024) if boot_mount else 0 %}
  {% set var_color = '#2ecc71' if var_free_gb >= 1 else '#e74c3c' %}
  {% set boot_color = '#2ecc71' if boot_free_mb >= 100 else '#e74c3c' %}
  {% set services = facts.get('services', {}) %}
  {% set db_keywords = ['mysql','mariadb','postgres','oracle','mongodb','redis','sql'] %}
  {% set db_services = [] %}
  {% if services is mapping %}
    {% for svc, info in services.items() %}
      {% if info.state is defined and 'running' in info.state %}
        {% for keyword in db_keywords %}
          {% if keyword in svc and svc not in db_services %}
            {% set _ = db_services.append(svc) %}
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endfor %}
  {% endif %}
  {% set is_db_server = db_services | length > 0 %}

  <tr>
    <td>{{ facts.get('ansible_hostname', host) }}</td>
    <td>{{ facts.get('ansible_default_ipv4', {}).get('address', 'N/A') }}</td>
    <td>{{ facts.get('ansible_distribution', 'Unknown') }} {{ facts.get('ansible_distribution_version', '') }}</td>
    <td>{{ facts.get('ansible_kernel', 'N/A') }}</td>
    <td>{{ (root_mount.size_total / 1024 / 1024 / 1024) | round(1) if root_mount else 'N/A' }} GB</td>
    <td><span style="color: {{ var_color }};">{{ var_free_gb | round(2) }} GB</span></td>
    <td><span style="color: {{ boot_color }};">{{ boot_free_mb | round(1) }} MB</span></td>
    <td>{% if db_services %}{{ db_services | join(', ') }}{% else %}-{% endif %}</td>
    <td>{% if is_db_server %}<b>Database Server</b>{% else %}Application Server{% endif %}</td>
    <td>
      {% if reachable %}
        <span style="color: #2ecc71;">✅ Live</span>
      {% else %}
        <span style="color: #e74c3c;">❌ Unreachable</span>
      {% endif %}
    </td>
  </tr>
{% endfor %}
  </tbody>
</table>